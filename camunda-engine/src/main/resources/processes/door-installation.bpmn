<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             id="definitions-doorInstallation"
             targetNamespace="http://camunda.org/examples">

  <process id="doorInstallationProcess" name="Door Installation Process" isExecutable="true">
    <documentation>
      POC Process: Door Installation Approval Workflow
      Migrates subset of Samrum Bizagi processes to Camunda 7
      Demonstrates: User tasks, gateways, variables, and approvals
    </documentation>

    <!-- Start Event: Process triggered by API call -->
    <startEvent id="startEvent" name="Process Started">
      <outgoing>flow1</outgoing>
    </startEvent>

    <!-- User Task 1: Design Review -->
    <userTask id="designReview" name="Design Review" camunda:assignee="${reviewerId}" camunda:candidateGroups="engineers">
      <documentation>
        Engineer reviews door design drawings and specifications.
        Can approve, reject, or request changes.
      </documentation>
      <incoming>flow1</incoming>
      <outgoing>flow2</outgoing>
    </userTask>

    <!-- Sequence Flow: Start → Design Review -->
    <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="designReview" />

    <!-- User Task 2: Complete Review Form -->
    <userTask id="reviewDecision" name="Submit Review Decision" camunda:assignee="${reviewerId}">
      <documentation>
        Submit approval decision with comments.
        Variables: approvalDecision (APPROVED/REJECTED/CHANGES_NEEDED), comments
      </documentation>
      <incoming>flow2</incoming>
      <outgoing>flow3</outgoing>
    </userTask>

    <!-- Sequence Flow: Design Review → Review Decision -->
    <sequenceFlow id="flow2" sourceRef="designReview" targetRef="reviewDecision" />

    <!-- Exclusive Gateway: Decision Point -->
    <exclusiveGateway id="approvalGateway" name="Approval Decision">
      <incoming>flow3</incoming>
      <outgoing>flowApproved</outgoing>
      <outgoing>flowRejected</outgoing>
      <outgoing>flowChangesNeeded</outgoing>
    </exclusiveGateway>

    <!-- Sequence Flow: Review Decision → Gateway -->
    <sequenceFlow id="flow3" sourceRef="reviewDecision" targetRef="approvalGateway" />

    <!-- Path 1: Approved -->
    <sequenceFlow id="flowApproved" name="Approved" sourceRef="approvalGateway" targetRef="sendApprovalNotification">
      <conditionExpression xsi:type="tFormalExpression">${approvalDecision == 'APPROVED'}</conditionExpression>
    </sequenceFlow>

    <!-- Service Task: Send Approval Notification -->
    <serviceTask id="sendApprovalNotification" name="Send Approval Notification" camunda:class="com.samrum.delegate.ApprovalNotificationDelegate">
      <incoming>flowApproved</incoming>
      <outgoing>flowToApprovedEnd</outgoing>
    </serviceTask>

    <!-- Sequence Flow: Notification → Approved End -->
    <sequenceFlow id="flowToApprovedEnd" sourceRef="sendApprovalNotification" targetRef="approvedEnd" />

    <!-- End Event: Process Completed Successfully -->
    <endEvent id="approvedEnd" name="Door Approved">
      <incoming>flowToApprovedEnd</incoming>
    </endEvent>

    <!-- Path 2: Rejected -->
    <sequenceFlow id="flowRejected" name="Rejected" sourceRef="approvalGateway" targetRef="sendRejectionNotification">
      <conditionExpression xsi:type="tFormalExpression">${approvalDecision == 'REJECTED'}</conditionExpression>
    </sequenceFlow>

    <!-- Service Task: Send Rejection Notification -->
    <serviceTask id="sendRejectionNotification" name="Send Rejection Notification" camunda:class="com.samrum.delegate.RejectionNotificationDelegate">
      <incoming>flowRejected</incoming>
      <outgoing>flowToRejectedEnd</outgoing>
    </serviceTask>

    <!-- Sequence Flow: Notification → Rejected End -->
    <sequenceFlow id="flowToRejectedEnd" sourceRef="sendRejectionNotification" targetRef="rejectedEnd" />

    <!-- End Event: Process Rejected -->
    <endEvent id="rejectedEnd" name="Door Rejected">
      <incoming>flowToRejectedEnd</incoming>
    </endEvent>

    <!-- Path 3: Changes Needed -->
    <sequenceFlow id="flowChangesNeeded" name="Changes Needed" sourceRef="approvalGateway" targetRef="reviseDesign">
      <conditionExpression xsi:type="tFormalExpression">${approvalDecision == 'CHANGES_NEEDED'}</conditionExpression>
    </sequenceFlow>

    <!-- User Task 3: Revise Design -->
    <userTask id="reviseDesign" name="Revise Design" camunda:assignee="${designerId}" camunda:candidateGroups="designers">
      <documentation>
        Designer makes requested changes to door design.
        Resubmits for review.
      </documentation>
      <incoming>flowChangesNeeded</incoming>
      <outgoing>flow6</outgoing>
    </userTask>

    <!-- Sequence Flow: Revise → Back to Design Review -->
    <sequenceFlow id="flow6" sourceRef="reviseDesign" targetRef="designReview" />

  </process>

  <!-- BPMN Diagram Visualization -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_doorInstallation">
    <bpmndi:BPMNPlane id="BPMNPlane_doorInstallation" bpmnElement="doorInstallationProcess">
      <!-- Start Event -->
      <bpmndi:BPMNShape id="startEvent_di" bpmnElement="startEvent">
        <dc:Bounds x="100" y="100" width="36" height="36" />
      </bpmndi:BPMNShape>

      <!-- Design Review Task -->
      <bpmndi:BPMNShape id="designReview_di" bpmnElement="designReview">
        <dc:Bounds x="200" y="78" width="100" height="80" />
      </bpmndi:BPMNShape>

      <!-- Review Decision Task -->
      <bpmndi:BPMNShape id="reviewDecision_di" bpmnElement="reviewDecision">
        <dc:Bounds x="360" y="78" width="100" height="80" />
      </bpmndi:BPMNShape>

      <!-- Gateway -->
      <bpmndi:BPMNShape id="approvalGateway_di" bpmnElement="approvalGateway" isMarkerVisible="true">
        <dc:Bounds x="520" y="93" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="505" y="150" width="80" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Approved Path -->
      <bpmndi:BPMNShape id="sendApprovalNotification_di" bpmnElement="sendApprovalNotification">
        <dc:Bounds x="640" y="10" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="approvedEnd_di" bpmnElement="approvedEnd">
        <dc:Bounds x="800" y="18" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="785" y="60" width="66" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Rejected Path -->
      <bpmndi:BPMNShape id="sendRejectionNotification_di" bpmnElement="sendRejectionNotification">
        <dc:Bounds x="640" y="100" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="rejectedEnd_di" bpmnElement="rejectedEnd">
        <dc:Bounds x="800" y="108" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="785" y="150" width="66" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Changes Needed Path -->
      <bpmndi:BPMNShape id="reviseDesign_di" bpmnElement="reviseDesign">
        <dc:Bounds x="520" y="200" width="100" height="80" />
      </bpmndi:BPMNShape>

      <!-- Sequence Flows -->
      <bpmndi:BPMNEdge id="flow1_di" bpmnElement="flow1">
        <di:waypoint x="136" y="118" />
        <di:waypoint x="200" y="118" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="flow2_di" bpmnElement="flow2">
        <di:waypoint x="300" y="118" />
        <di:waypoint x="360" y="118" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="flow3_di" bpmnElement="flow3">
        <di:waypoint x="460" y="118" />
        <di:waypoint x="520" y="118" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="flowApproved_di" bpmnElement="flowApproved">
        <di:waypoint x="545" y="93" />
        <di:waypoint x="545" y="50" />
        <di:waypoint x="640" y="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="550" y="60" width="50" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="flowToApprovedEnd_di" bpmnElement="flowToApprovedEnd">
        <di:waypoint x="740" y="50" />
        <di:waypoint x="800" y="50" />
        <di:waypoint x="800" y="36" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="flowRejected_di" bpmnElement="flowRejected">
        <di:waypoint x="570" y="118" />
        <di:waypoint x="640" y="118" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="580" y="100" width="50" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="flowToRejectedEnd_di" bpmnElement="flowToRejectedEnd">
        <di:waypoint x="740" y="140" />
        <di:waypoint x="800" y="140" />
        <di:waypoint x="800" y="126" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="flowChangesNeeded_di" bpmnElement="flowChangesNeeded">
        <di:waypoint x="545" y="143" />
        <di:waypoint x="545" y="200" />
        <di:waypoint x="570" y="200" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="550" y="160" width="90" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="flow6_di" bpmnElement="flow6">
        <di:waypoint x="570" y="240" />
        <di:waypoint x="400" y="240" />
        <di:waypoint x="400" y="158" />
        <di:waypoint x="400" y="118" />
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</definitions>
